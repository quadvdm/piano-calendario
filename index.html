<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escuela de Piano - Prueba Login</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding-top: 50px;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px;
        }
        #status {
            margin: 20px auto;
            padding: 15px;
            max-width: 500px;
            border-radius: 5px;
            background-color: #f0f8ff;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <h1>üéπ Escuela de Piano - Prueba de Login</h1>
    <p>URL de la prueba: <strong id="currentUrl"></strong></p>
    <p>Site URL configurada en Supabase: <strong id="siteUrlTarget"></strong></p>

    <div id="status">Haz clic en el bot√≥n para iniciar.</div>

    <button onclick="loginWithGoogle()">Iniciar Sesi√≥n con Google</button>
    <div id="userInfo" style="display:none; margin-top: 20px;">
        <h3>‚úÖ ¬°Sesi√≥n Iniciada!</h3>
        <p id="userName"></p>
        <button onclick="logout()">Cerrar Sesi√≥n</button>
    </div>

    <script>
        // 1. CONFIGURACI√ìN - Reemplaza con tus valores si es necesario
        const SUPABASE_URL = 'https://yhwtlbcckdegbggjaems.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlod3RsYmNja2RlZ2JnZ2phZW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDQyODIsImV4cCI6MjA4MTUyMDI4Mn0.ab35WTtpZGJ4VP-3Dkr0SdQN5hK5ZC5uxeVLJiarWs8';
        // Esta es la URL a la que Supabase te redirigir√°. Debe coincidir con la "Site URL" en el Dashboard de Supabase.
        const SITE_REDIRECT_URL = 'https://lovely-lamington-133500.netlify.app';

        // Mostrar URLs en pantalla para referencia
        document.getElementById('currentUrl').textContent = window.location.href;
        document.getElementById('siteUrlTarget').textContent = SITE_REDIRECT_URL;

        // 2. Inicializar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Cliente Supabase inicializado para:", SUPABASE_URL);

        // 3. Funci√≥n principal de Login
        async function loginWithGoogle() {
            console.log("Funci√≥n loginWithGoogle() ejecutada.");
            document.getElementById('status').innerHTML = "üîó Conectando con Google...";

            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        // El par√°metro 'redirectTo' es clave. Indica a d√≥nde ir√° el usuario tras la autenticaci√≥n.
                        redirectTo: SITE_REDIRECT_URL
                    }
                });

                if (error) {
                    console.error("Error de Supabase al iniciar OAuth:", error);
                    document.getElementById('status').innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
                    // Si el error es de redirecci√≥n, te dar√° una pista clara.
                    if (error.message.includes('redirect')) {
                        document.getElementById('status').innerHTML += `<p><small>Aseg√∫rate de que <strong>${SITE_REDIRECT_URL}</strong> est√© en "Site URL" y "Redirect URLs" en el Dashboard de Supabase.</small></p>`;
                    }
                } else {
                    console.log("Redirecci√≥n iniciada hacia:", data?.url || 'Google');
                    document.getElementById('status').innerHTML = "‚úÖ Redirigiendo a Google...";
                    // El navegador se redirigir√° autom√°ticamente. No necesitas hacer nada m√°s aqu√≠.
                }
            } catch (err) {
                console.error("Error inesperado:", err);
                document.getElementById('status').innerHTML = `<span class="error">‚ö†Ô∏è Error inesperado: ${err.message}</span>`;
            }
        }

        // 4. Verificar si el usuario ya tiene una sesi√≥n activa (al cargar la p√°gina)
        async function checkUser() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.warn("Error al verificar sesi√≥n:", error);
            } else if (session?.user) {
                showUserInfo(session.user);
            }
        }

        function showUserInfo(user) {
            document.getElementById('userName').textContent = `Hola, ${user.email}`;
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('status').innerHTML = "‚úÖ Ya tienes una sesi√≥n activa.";
        }

        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (!error) {
                document.getElementById('userInfo').style.display = 'none';
                document.getElementById('status').innerHTML = "Sesi√≥n cerrada.";
            }
        }

        // 5. Ejecutar la verificaci√≥n de usuario cuando se carga la p√°gina
        window.addEventListener('DOMContentLoaded', checkUser);
    </script>

</body>
</html>
