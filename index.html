<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Escuela de Piano - Sistema de Reservas</title>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            text-align: center; 
            padding: 50px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 30px 0;
            transition: transform 0.3s, box-shadow 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }
        
        .login-btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }
        
        .user-info {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 30px 0;
            border-left: 5px solid #4285f4;
        }
        
        .calendar-placeholder {
            background: #f0f2f5;
            padding: 40px;
            border-radius: 15px;
            margin: 30px 0;
            border: 2px dashed #ddd;
        }
        
        .logout-btn {
            background: #ea4335;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .hidden { display: none; }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .piano-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="piano-icon"></div>
        <h1>Escuela de Piano</h1>
        <p>Sistema de reserva de turnos</p>
        
        <!-- Secci贸n de Autenticaci贸n -->
        <div id="auth-section">
            <p>Inicia sesi贸n para gestionar tus horarios de pr谩ctica</p>
            <button class="login-btn" onclick="login()">
                Iniciar Sesi贸n con Google
            </button>
            <div id="auth-error" class="hidden error-message"></div>
        </div>
        
        <!-- Secci贸n de Aplicaci贸n (oculta inicialmente) -->
        <div id="app-section" class="hidden">
            <div id="user-info" class="user-info">
                <h3>隆Bienvenido!</h3>
                <p id="user-email"></p>
                <p id="user-name"></p>
            </div>
            
            <h2> Tu Calendario de Reservas</h2>
            <div class="calendar-placeholder" id="calendar">
                <p>Calendario interactivo</p>
                <p>Aqu铆 podr谩s ver y gestionar tus horarios de pr谩ctica</p>
            </div>
            
            <button class="logout-btn" onclick="logout()">Cerrar Sesi贸n</button>
        </div>
        
        <div style="margin-top: 40px; color: #666; font-size: 14px;">
            <p>Usando Supabase + Google OAuth + Netlify</p>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuraci贸n de Supabase
        const SUPABASE_URL = 'https://yhwtlbcckdegbggjaems.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlod3RsYmNja2RlZ2JnZ2phZW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDQyODIsImV4cCI6MjA4MTUyMDI4Mn0.ab35WTtpZGJ4VP-3Dkr0SdQN5hK5ZC5uxeVLJiarWs8';
        
        // Inicializar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Manejar autenticaci贸n al cargar la p谩gina
        async function initAuth() {
            console.log('Inicializando autenticaci贸n...');
            
            // Verificar si hay tokens en el hash de la URL
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            
            const accessToken = params.get('access_token');
            const refreshToken = params.get('refresh_token');
            const error = params.get('error');
            
            console.log('Par谩metros en URL:', { accessToken: !!accessToken, hasError: !!error });
            
            // CASO 1: Tenemos error
            if (error) {
                showError(`Error de autenticaci贸n: ${error}`);
                return;
            }
            
            // CASO 2: Tenemos token de acceso
            if (accessToken) {
                console.log('Token recibido, estableciendo sesi贸n...');
                
                try {
                    // Limpiar hash de la URL
                    window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
                    
                    // Establecer sesi贸n con los tokens
                    const { data, error: sessionError } = await supabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken || ''
                    });
                    
                    if (sessionError) throw sessionError;
                    
                    // Mostrar aplicaci贸n
                    await showApp();
                    
                } catch (error) {
                    console.error('Error al establecer sesi贸n:', error);
                    showError('Error al iniciar sesi贸n: ' + error.message);
                }
                
                return;
            }
            
            // CASO 3: Verificar si ya hay sesi贸n activa
            const { data: { session }, error: sessionCheckError } = await supabase.auth.getSession();
            
            if (sessionCheckError) {
                console.error('Error al verificar sesi贸n:', sessionCheckError);
            }
            
            if (session) {
                console.log('Sesi贸n ya activa');
                await showApp();
            } else {
                console.log('No hay sesi贸n activa');
                showAuth();
            }
        }
        
        // Iniciar sesi贸n con Google
        function login() {
            console.log('Iniciando login...');
            
            // Limpiar cach茅 local
            localStorage.clear();
            sessionStorage.clear();
            
            // Usar GitHub Pages como proxy OAuth
            const proxyUrl = 'https://quadvdm.github.io/piano-calendario/oauth-proxy.html';
            console.log('Redirigiendo a proxy:', proxyUrl);
            
            window.location.href = proxyUrl;
        }
        
        // Cerrar sesi贸n
        async function logout() {
            try {
                await supabase.auth.signOut();
                showAuth();
                console.log('Sesi贸n cerrada');
            } catch (error) {
                console.error('Error al cerrar sesi贸n:', error);
            }
        }
        
        // Mostrar secci贸n de autenticaci贸n
        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
            document.getElementById('auth-error').classList.add('hidden');
        }
        
        // Mostrar aplicaci贸n principal
        async function showApp() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    // Mostrar informaci贸n del usuario
                    document.getElementById('user-email').textContent = ` ${user.email}`;
                    document.getElementById('user-name').textContent = ` ${user.user_metadata?.full_name || 'Usuario'}`;
                    
                    // Mostrar secciones
                    document.getElementById('auth-section').classList.add('hidden');
                    document.getElementById('app-section').classList.remove('hidden');
                    document.getElementById('auth-error').classList.add('hidden');
                    
                    console.log('Usuario autenticado:', user.email);
                    
                    // Aqu铆 puedes cargar el calendario real
                    loadCalendar(user.id);
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Error al obtener usuario:', error);
                showError('Error al cargar informaci贸n del usuario');
            }
        }
        
        // Mostrar error
        function showError(message) {
            const errorElement = document.getElementById('auth-error');
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            showAuth();
        }
        
        // Cargar calendario (placeholder por ahora)
        async function loadCalendar(userId) {
            console.log('Cargando calendario para usuario:', userId);
            
            // Aqu铆 implementar谩s la l贸gica real del calendario
            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = `
                <h3> Calendario de ${userId}</h3>
                <p>Pr贸ximas caracter铆sticas:</p>
                <ul style="text-align: left; display: inline-block;">
                    <li>Ver horarios reservados</li>
                    <li>Cambiar a horarios disponibles</li>
                    <li>Notificaciones de recordatorio</li>
                    <li>Historial de pr谩cticas</li>
                </ul>
                <p style="margin-top: 20px; color: #4285f4; font-weight: bold;">
                     Funcionalidad en desarrollo
                </p>
            `;
        }
        
        // Inicializar cuando se carga la p谩gina
        document.addEventListener('DOMContentLoaded', initAuth);
        
        // Tambi茅n manejar cambios en el hash (para cuando regresa de OAuth)
        window.addEventListener('hashchange', initAuth);
    </script>
</body>
</html>
