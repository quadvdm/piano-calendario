<!DOCTYPE html>
<html>
<head>
    <title>Debug Login Piano</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; max-width: 800px; margin: 0 auto; }
        h1 { color: #333; text-align: center; }
        .config-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007bff; }
        .error-box { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #dc3545; }
        .success-box { background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #28a745; }
        button { background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #3367d6; }
        .code { background: #333; color: #0f0; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 10px 0; overflow: auto; }
        .step { margin: 20px 0; padding: 10px; }
        .url { background: #e9ecef; padding: 8px; border-radius: 4px; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Completo - Login Piano</h1>
        
        <div class="config-box">
            <h3>üìã Configuraci√≥n Actual:</h3>
            <p><strong>Supabase URL:</strong> <span class="url">https://yhwtlbcckdegbggjaems.supabase.co</span></p>
            <p><strong>Supabase Key:</strong> <span class="url">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...</span></p>
            <p><strong>Google Client ID:</strong> <span class="url">35991205187-6t6jka8t93d4lpua8cgaeu7pgjh4g5ce.apps.googleusercontent.com</span></p>
            <p><strong>Netlify URL:</strong> <span class="url">https://lovely-lamington-133500.netlify.app</span></p>
        </div>
        
        <div class="step">
            <h3>1Ô∏è‚É£ Verificar Supabase Connection</h3>
            <button onclick="testSupabaseConnection()">Probar Conexi√≥n Supabase</button>
            <div id="supabaseResult"></div>
        </div>
        
        <div class="step">
            <h3>2Ô∏è‚É£ Login Normal (m√©todo Supabase)</h3>
            <button onclick="loginNormal()">Login Normal con Google</button>
            <div id="normalResult"></div>
        </div>
        
        <div class="step">
            <h3>3Ô∏è‚É£ Login Manual (URL directa)</h3>
            <button onclick="loginManual()">Login Manual (URL directa)</button>
            <div id="manualResult">
                <p><strong>URL de login manual:</strong></p>
                <div class="code" id="manualUrl"></div>
            </div>
        </div>
        
        <div class="step">
            <h3>4Ô∏è‚É£ Ver Sesi√≥n Actual</h3>
            <button onclick="checkSession()">Verificar Sesi√≥n</button>
            <div id="sessionResult"></div>
        </div>
        
        <div class="step">
            <h3>üìù Debug Console</h3>
            <div class="code" id="debugConsole">Esperando acciones...</div>
        </div>
        
        <div class="config-box">
            <h3>‚ö†Ô∏è Problemas Conocidos y Soluciones:</h3>
            <ol>
                <li><strong>Google usa GitHub en lugar de Netlify:</strong> Quitar <code>https://quadvdm.github.io</code> de URIs de redirecci√≥n en Google Cloud</li>
                <li><strong>Supabase guard√≥ localhost:3000:</strong> Reconfigurar Google provider en Supabase con URL de Netlify</li>
                <li><strong>Redirect URI mismatch:</strong> Asegurar que Netlify URL est√© en ambos lugares (Google Cloud y Supabase)</li>
            </ol>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ================= CONFIGURACI√ìN =================
        const SUPABASE_URL = 'https://yhwtlbcckdegbggjaems.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlod3RsYmNja2RlZ2JnZ2phZW1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NDQyODIsImV4cCI6MjA4MTUyMDI4Mn0.ab35WTtpZGJ4VP-3Dkr0SdQN5hK5ZC5uxeVLJiarWs8';
        const NETLIFY_URL = 'https://lovely-lamington-133500.netlify.app';
        
        // Mostrar URL manual
        document.getElementById('manualUrl').textContent = 
            SUPABASE_URL + '/auth/v1/authorize?provider=google&redirect_to=' + encodeURIComponent(NETLIFY_URL + '/debug-login.html');
        
        let supabase = null;
        
        // ================= FUNCIONES DEBUG =================
        function addDebug(msg) {
            const consoleDiv = document.getElementById('debugConsole');
            const time = new Date().toLocaleTimeString();
            consoleDiv.innerHTML = `[${time}] ${msg}<br>` + consoleDiv.innerHTML;
            console.log(msg);
        }
        
        function showResult(divId, msg, type = 'info') {
            const div = document.getElementById(divId);
            div.innerHTML = `<div class="${type}-box">${msg}</div>`;
        }
        
        // ================= TEST SUPABASE =================
        async function testSupabaseConnection() {
            addDebug('=== TEST SUPABASE CONNECTION ===');
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                addDebug('‚úÖ Supabase client creado');
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    showResult('supabaseResult', `‚ùå Error: ${error.message}`, 'error');
                    addDebug(`‚ùå Error sesi√≥n: ${error.message}`);
                } else if (session) {
                    showResult('supabaseResult', `‚úÖ Conexi√≥n OK. Sesi√≥n activa: ${session.user.email}`, 'success');
                    addDebug(`‚úÖ Sesi√≥n activa: ${session.user.email}`);
                } else {
                    showResult('supabaseResult', '‚úÖ Conexi√≥n OK. No hay sesi√≥n activa.', 'success');
                    addDebug('‚úÖ Conexi√≥n OK, sin sesi√≥n');
                }
            } catch (err) {
                showResult('supabaseResult', `‚ùå Excepci√≥n: ${err.message}`, 'error');
                addDebug(`‚ùå Excepci√≥n: ${err.message}`);
            }
        }
        
        // ================= LOGIN NORMAL =================
        async function loginNormal() {
            addDebug('=== LOGIN NORMAL ===');
            
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: NETLIFY_URL + '/debug-login.html'
                    }
                });
                
                if (error) {
                    showResult('normalResult', `‚ùå Error: ${error.message}`, 'error');
                    addDebug(`‚ùå Error login: ${error.message}`);
                    
                    // Diagn√≥stico espec√≠fico
                    if (error.message.includes('redirect_uri')) {
                        addDebug('üîç PROBLEMA: redirect_uri mismatch');
                        addDebug('üí° SOLUCI√ìN: Verificar Redirect URL en Supabase dashboard');
                    }
                } else {
                    showResult('normalResult', '‚úÖ Redirigiendo a Google...', 'success');
                    addDebug('‚úÖ Redirecci√≥n iniciada');
                }
            } catch (err) {
                showResult('normalResult', `‚ùå Excepci√≥n: ${err.message}`, 'error');
                addDebug(`‚ùå Excepci√≥n login: ${err.message}`);
            }
        }
        
        // ================= LOGIN MANUAL =================
        function loginManual() {
            addDebug('=== LOGIN MANUAL ===');
            const manualUrl = SUPABASE_URL + '/auth/v1/authorize?provider=google&redirect_to=' + encodeURIComponent(NETLIFY_URL + '/debug-login.html');
            
            addDebug(`URL manual: ${manualUrl}`);
            showResult('manualResult', `‚úÖ Redirigiendo a:<br><div class="url">${manualUrl}</div>`, 'success');
            
            // Redirigir despu√©s de 2 segundos
            setTimeout(() => {
                window.location.href = manualUrl;
            }, 2000);
        }
        
        // ================= VER SESSION =================
        async function checkSession() {
            addDebug('=== CHECK SESSION ===');
            
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            }
            
            const { data: { user }, error } = await supabase.auth.getUser();
            
            if (error) {
                showResult('sessionResult', `‚ùå Error: ${error.message}`, 'error');
                addDebug(`‚ùå Error user: ${error.message}`);
            } else if (user) {
                showResult('sessionResult', 
                    `‚úÖ USUARIO AUTENTICADO:<br>
                    <strong>Email:</strong> ${user.email}<br>
                    <strong>Nombre:</strong> ${user.user_metadata.full_name || 'No disponible'}<br>
                    <strong>ID:</strong> ${user.id.substring(0, 8)}...`, 
                    'success');
                addDebug(`‚úÖ Usuario: ${user.email}`);
            } else {
                showResult('sessionResult', '‚ö†Ô∏è No hay usuario autenticado', 'error');
                addDebug('‚ö†Ô∏è Sin usuario');
            }
        }
        
        // ================= VERIFICAR AL CARGAR =================
        window.addEventListener('DOMContentLoaded', async () => {
            addDebug('P√°gina cargada');
            addDebug(`URL: ${window.location.href}`);
            
            // Verificar si hay par√°metros de OAuth en la URL
            const hash = window.location.hash.substring(1);
            const search = window.location.search;
            
            if (hash || search.includes('error') || search.includes('code')) {
                addDebug(`Hash encontrado: ${hash.substring(0, 50)}...`);
                addDebug(`Search: ${search}`);
                
                showResult('sessionResult', 
                    `üîç Par√°metros OAuth detectados en URL.<br>
                    Esto significa que Google redirigi√≥ aqu√≠.<br>
                    <button onclick="checkSession()">Click aqu√≠ para procesar</button>`, 
                    'success');
            }
            
            // Inicializar Supabase
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        });
    </script>
</body>
</html>
